#!/bin/sh

REGION=us-east-2
BUCKET=cobalt

function fail() {
    echo $2
    exit $1
}

echo "Creating S3 bucket..."

aws --endpoint-url=http://localstack-cobalt:4801 s3api create-bucket --bucket ${BUCKET} --region ${REGION}
aws --endpoint-url=http://localstack-cobalt:4801 s3api put-bucket-acl --bucket ${BUCKET} --region ${REGION} --acl public-read
aws --endpoint-url=http://localstack-cobalt:4801 s3api put-bucket-cors --bucket ${BUCKET} --region ${REGION} --cors-configuration file://s3-bucket-cors.json

echo "Creating SQS email queue..."

aws --endpoint-url=http://localstack-cobalt:4801 sqs delete-queue --queue-url http://localstack-cobalt:4801/queue/email-messages-local.fifo --region ${REGION} > /dev/null 2>&1
aws --endpoint-url=http://localstack-cobalt:4801 sqs create-queue --queue-name email-messages-local.fifo --region ${REGION} --attributes "FifoQueue=true,VisibilityTimeout=600,ReceiveMessageWaitTimeSeconds=20,ContentBasedDeduplication=true" 1> /dev/null

[ $? == 0 ] || fail 1 "Failed: AWS / sqs / create-queue email-messages-local.fifo"

aws --endpoint-url=http://localstack-cobalt:4801 ses verify-email-identity --email-address no-reply@cobaltplatform.com --region ${REGION}

[ $? == 0 ] || fail 1 "Failed: AWS / ses / verify-email-identity"

echo "Creating SQS SMS queue..."

aws --endpoint-url=http://localstack-cobalt:4801 sqs delete-queue --queue-url http://localstack-cobalt:4801/queue/sms-messages-local.fifo --region ${REGION} > /dev/null 2>&1
aws --endpoint-url=http://localstack-cobalt:4801 sqs create-queue --queue-name sms-messages-local.fifo --region ${REGION} --attributes "FifoQueue=true,VisibilityTimeout=600,ReceiveMessageWaitTimeSeconds=20,ContentBasedDeduplication=true" 1> /dev/null

[ $? == 0 ] || fail 1 "Failed: AWS / sqs / create-queue sms-messages-local.fifo"

echo "Creating SQS call queue..."

aws --endpoint-url=http://localstack-cobalt:4801 sqs delete-queue --queue-url http://localstack-cobalt:4801/queue/call-messages-local.fifo --region ${REGION} > /dev/null 2>&1
aws --endpoint-url=http://localstack-cobalt:4801 sqs create-queue --queue-name call-messages-local.fifo --region ${REGION} --attributes "FifoQueue=true,VisibilityTimeout=600,ReceiveMessageWaitTimeSeconds=20,ContentBasedDeduplication=true" 1> /dev/null

[ $? == 0 ] || fail 1 "Failed: AWS / sqs / create-queue call-messages-local.fifo"

echo "Localstack initialization complete."
